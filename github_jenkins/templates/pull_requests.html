{% extends "base.html" %}
{% load url from future %}

{% block script %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  $(document).ready(function() {
    var delay;
    var make_short_delay = function () {
      return 5000 + (Math.random() * 4000);
    };
    $("#pull-request-table-body").data("max-pr", {{ max_pr_number }});

    var get_new_pull_requests = function() {
      var max_pr_number = $("#pull-request-table-body").data("max-pr");
      $.getJSON("{% url "pull_requests" owner=project.owner project=project.name %}" + "new/" + max_pr_number + "/")
        .done(function(json) {
          $("#pull-request-table-body").data("max-pr", json.max_pr_number);
          var previous_row = $("#pull-request-table-body tr:first");
          $.each(json.rows, function(index, elem) {
            var tr = $("<tr id=\"" + elem.pr_id + "\"></tr>").insertAfter(previous_row);
            tr.append("<td><a href=\"" + elem.pr_issue_url + "\">" + elem.pr_number + "</a></td>");
            tr.append("<td>" + elem.pr_title + "</td>");
            if (elem.build_number === null) {
              tr.append("<td/>");
            } else {
              tr.append("<td><a href=\"" + elem.build_url + "\">" + elem.build_number + "</a></td>");
            };
            if (elem.build_status === null) {
              tr.append("<td/>");
            } else {
              tr.append("<td>" + elem.build_status + "</td>");
            };
            tr.append("<td><a href=\"" + elem.build_now_url + "\">Build now</a></td>");
          });
          var delay = make_short_delay();
          window.setTimeout(get_new_pull_requests, delay);
        })
        .fail(function() {
          var delay = make_short_delay();
          window.setTimeout(get_new_pull_requests, delay);
        });
    };
    delay = make_short_delay()
    window.setTimeout(get_new_pull_requests, delay);

{% for pr_id, pr, build in pr_builds %}
    var reload_pr_{{ pr.number }} = function() {
      $.get("{% url "update_pull_request" owner=project.owner project=project.name pr_number=pr.number %}")
        .done(function(data) {
           $("#{{ pr_id }}").replaceWith(data);
           var delay = make_short_delay();
           window.setTimeout(reload_pr_{{ pr.number }}, delay);
        })
        .fail(function() {
           $("#{{ pr_id }}").remove();
        });
    };
    delay = make_short_delay();
    window.setTimeout(reload_pr_{{ pr.number }}, delay);
{% endfor %}
  });
</script>
{% endblock %}

{% block content %}
<div>
  <h3>Project: {{ project.full_name }}</h3>
{% include "pull_requests_body.html" %}
</div>

<div>
  <a rel="nofollow" class="logout" href="/github-jenkins/logout/">Logout</a>
</div>
{% endblock %}
